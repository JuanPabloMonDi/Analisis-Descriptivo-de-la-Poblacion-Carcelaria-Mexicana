---
title: "Agrupamiento"
author: "Juan Pablo Montaño Díaz & Laura Katherine Martinez Castiblanco"
format: html
editor: source
---

Finalmente, para concluir el análisis estadístico de nuestro estudio,agruparemos a los individuos a partir de sus características, con el fin de encontrar patrones en la población encuestada.

Para el agrupamiento de los individuos, se utilizará el método jerárquico de Ward y el método de Kmeans. Para realizar el análisis estadístico, se utilizarán los mismas librerias de R usadas en los análisis de ACP y ACM.

```{r}
#| label: carga-librerias
#| message: false
#| code-fold: show
#| output: false

#Manejo de datos
library(tidyverse)
library(readr)
library(dplyr)
library(readxl)
#Gráficos
library(ggplot2)
library(gridExtra)
library(plotly)
library(GGally)
#ACP
library(ade4)
library(FactoClass)
library(FactoMineR)
library(factoextra)
#Datos importados
source("DatosSeleccionados.R")

#Ajustes de tema del documento y graficos
library(scales)
library(DT)
library(gt)
library(RColorBrewer)
theme_set(theme_minimal(base_size = 24, base_family = "Atkinson Hyperlegible"))
library(hrbrthemes)
options(scipen=999) #Evitar notación científica
```

En este caso, nos centraremos únicamente en el análisis factorial que presentó mayores y mejores resultados relacionados con el objetivo de nuestro estudio, es decir, realizaremos el agrupamiento de los individuos basándonos en el análisis de correspondencias múltiples realizado para las variables que presentaron una relación clara con la cantidad de personas con las cuales los individuos comparten celda, los cuales fueron las variables de vida intracarcelaria.

La siguiente tabla muestra nuestro conjunto de datos considerado para el ACM y agrupamiento.

```{r}
#| label: Selección1
#| echo: false
#| message: false
#| warning: false
#| output: true

#Variables seleccionadas en el ACM
Var_cuali_intra<-c(
 "CAR_PERSONAS_CELDA",
 "CELDA_VENTANAS",
 "CELDA_AGUA_POTABLE" ,
 "CELDA_DRENAJE",
 "CELDA_LUZ",
 "CELDA_DUCHA" ,
 "CELDA_SANITARIO" ,
 "CELDA_SERVICIO_MEDICO",
 "CELDA_ALIMENTOS",
 "CARCEL_EJERCICIO",
 "CARCEL_LECTURA" ,
 "CARCEL_RELIGION" ,
 "CARCEL_LLAMADAS" ,
 "CARCEL_ESTUDIO" ,
 "CARCEL_VISITA" ,
 "CELDA_SEGURIDAD" ,
 "CARCEL_SEGURIDAD",
 "TIPO_CARCEL",
 "TIEMPO_CARCEL",
 "ORIENT_SEXUAL",
 "SEXO"
)

DatosCualiIntra<-Tabla1[,Var_cuali_intra]
DatosCualiIntra[]<-lapply(DatosCualiIntra, as.factor)
kable(head(DatosCualiIntra, 10))
```

## Paso 1: Análisis factorial (ACM)

Las variables consideradas en el componente de vida intracarcelaria son las siguientes:

-   Sexo de la persona
-   Orientación sexual de la persona
-   Acceso a ventanas en la celda
-   Acceso a agua potable en la celda
-   Acesso a un sistema de drenaje en la celda
-   Acceso a luz electrica en la celda
-   Acceso a una ducha en la celda
-   Acceso a un sanitario en la celda
-   Acceso a servicio médico dentro de la celda
-   Acceso a alimentos gratuitos en la celda
-   Acceso a espacios de ejercicio en la carcel
-   Acceso a espacios y/o material de lectura en la carcel
-   Facilidad de ejercer la religión dentro de la carcel
-   Puede realizar llamadas dentro de la carcel
-   Puede continuar con sus estudios dentro de la carcel
-   Puede recibir visitas dentro de la carcel
-   Sensación de seguridad en la celda
-   Sensación de seguridad en la carcel
-   Tipo de carcel
-   Cantidad de personas en la celda

Posteriormente, realizamos el ACM mediante el siguiente comando

```{r}
#| code-fold: show
#| label: acmIntracarcelario
acmIntra <- MCA(DatosCualiIntra, graph=FALSE,level.ventil = 0.01,ncp=7)
```

Para evitar el ruido y distorsión de las categorías "No sabe/No responde" utilizamos la técnica de ventilación de variables; esta es implementada mediante el parámetro `level.ventil=0.01`, el cual disipa el efecto de aquellas categorías que contienen menos del 1% de la población en su respectiva variable cualitativa.

Los resultados de este ACM fueron mostrados previamente en la sección de [Análisis de Correspondencias Múltiples](ACM.qmd).

## Paso 2: Seleccionar el número de ejes

Para la selección del número de ejes a considerar en el ACM, utilizaremos el criterio de Benzécri, pues el screeplot tradicional puede verse afectado por la presencia de ejes "parásitos".

```{r}
#| label: screeplotIntra
#| echo: false
screeplot <- fviz_screeplot(acmIntra, addlabels = TRUE, ylim = c(0, 20)) +  ggtitle("Scree Plot") + theme_minimal()+ylab("Porcentaje de varianza explicada")+xlab("Ejes")
## Usando modif.rate() del paquete GDAtools:
# ptau <- modif.rate(acm)$modif[, 1]
## Haciendo las cuentas uno mismo:
s <- ncol(DatosCualiIntra)
l <- acmIntra$eig[acmIntra$eig[,1] > 1/s, 1]
tau <- ( s / (s - 1) )^2 * ( l - (1/s) )^2
ptau <- tau / sum( tau ) * 100

# Creamos un data frame para usar con ggplot2
barplot_df <- data.frame(Indice = factor(1:length(ptau)), Valor = ptau)

# Creamos el gráfico de barras con ggplot2
barplot_gg <- ggplot(barplot_df, aes(x = Indice, y = Valor)) +
  geom_bar(stat = "identity", fill = "darkred") +
  ylim(0, max(barplot_df$Valor+10)) +
  labs(x = "Ejes", y = expression(tau(lambda))) +
  theme_minimal() +
  ggtitle("Criterio de Benzécri")

grid.arrange(screeplot, barplot_gg, ncol = 1)
```

Al observar los valores de inercia ajustada por el criterio de Benzécri, obtenemos que los 3 primeros ejes acumulan alrededor del 90% de la inercia de los datos.

```{r}
#| label: Tabla-benzecriintra
#| echo: false
#| warning: false
#| output: true

kable(barplot_df[1:5,])
```

Por lo tanto, para nuestro agrupamiento, consideraremos únicamente los 3 primeros ejes de nuestro ACM. Luego, nuestras variables cuantitativas a agrupar mediante K-means son las coordenadas de los 3 primeros ejes de cada uno de los individuos.

```{r}
#| label: seleccionejes
#| code-fold: show
Y<-acmIntra$ind$coord[,1:3]
```

## Paso 3: Pre-agrupamiento

Dado que contamos con la información de 61449 individuos, es necesario realizar un preagrupamiento de los datos antes del agrupamiento jerárquico. Para esto, implementaremos el método de k-means para obtener 5000 grupos.

El método de K-means nos ayuda a que, dentro de cada uno de estos 5000 grupos, se posea una inercia mínima. En otras palabras, los individuos dentro de cada grupo son "parecidos" o próximos según su distancia euclidiana en las coordenadas.

```{r}
#| label: Preagrupamieto
#| code-fold: show
#| fig-cap: ''
#| fig-align: 'center'
#| fig-width: 5
#| fig-height: 5.5
set.seed(1311) #Fijamos la semilla
pregroup<- kmeans(Y, centers = 5000)  #Agrupamos los datos en 5000 grupos
```

## Paso 4: Agrupamiento Jerárquico

Ahora que tenemos 5000 grupos de individuos, realizaremos un agrupamiento jerárquico usando la distancia de Ward entre los centros de gravedad de los 5000 grupos. para esto se utiliza la función `ward.cluster` del paquete `FactoClass`.

Asi, obtenemos el siguiente dendograma de esta agrupación de grupos.

```         

kable(barplot_df[1:5,])
```

```{r}
#| label: jerarquico
#| fig-cap: ''
#| fig-align: 'center'
#| fig-width: 5
#| fig-height: 5.5
#| echo: false

hclCafe <- ward.cluster(dista=dist(pregroup$centers), h.clust=1) # función de FactoClass
plot(hclCafe, las=1, col="darkblue", main="", sub="", xlab="")
abline(h=seq(0, 7, 0.5), col="gray90", lty=3)
```

## Paso 5: Número total de grupos

Observando y analizando el dendograma anterior, se consideraron las ideas de clasificar la población en 4 o 7 grupos.Debido a esto, se hizo la agrupación de los individuos para estas 2 cantidades.

Al final, los 7 grupos resultantes no presentaban diferencias claras en sus categorías. Por lo tanto, se optó por agrupar a la población en 4 grupos, los cuales presentaban diferencias claras entre ellos.

El corte del árbol y la selección de grupos fueron realizadas mediante el siguiente comando

```{r}
#| label: numero-grupos
#| code-fold: show
grupos_jerarquicos <- cutree(hclCafe, k=4)
```

## Paso 6: Consolidación

Finalmente, realizamos nuestro K-means de consolidación a partir de los centros de gravedad obtenidos en el agrupamiento jerárquico.

```{r}
#| label: consolidacion
#| code-fold: true

set.seed(1311) #Fijamos semilla 

centros_de_gravedad <- aggregate(pregroup$centers, by = list(grupos_jerarquicos), FUN = mean) #Calculamos los centros de gravedad obtenidos para los 5000 grupos


kmeans_consolidacion <- kmeans(pregroup$centers, centers = centros_de_gravedad[, -1]) #Iniciamos kmeans con los centros de gravedad calculados

ordenados <- order(rowSums(kmeans_consolidacion$centers))

# Crear una nueva asignación de grupos reordenada
consolidacion <- match(kmeans_consolidacion$cluster, ordenados)

Grupos<-consolidacion[pregroup$cluster] #Obtenemos los grupos finales
#Grupos<-kmeans_consolidacion$cluster[pregroup$cluster] #Obtenemos los grupos finales
```

## Paso 7: Caracterización

Una vez obtenidos los grupos, realizamos un análisis descriptivo de estos para reconocer las variables que caracterizan a cada uno de estos 4 grupos.

Dado que se trata únicamente de variables cualitativas, haremos la caracterización a partir de los valores test y la tabla de perfiles entre los grupos y las demás variables.

```{r}
#| label: AsignacionGrupos
#| echo: false

Y<-as.data.frame(Y)
Y[["GrupoFinal"]]<-as.factor(Grupos)
DatosCualiIntra<-cbind(DatosCualiIntra,Y["GrupoFinal"])
valores_test<-cluster.carac(DatosCualiIntra[,1:21], DatosCualiIntra$GrupoFinal)
```

Para comenzar, veamos como se repartió la población en cada uno de los grupos.

```{r}
#| label: PorcentajesGrupos
#| echo: false

kable(table(DatosCualiIntra$GrupoFinal)/nrow(DatosCualiIntra)*100)
```

De esta forma, vemos que la mayoría de los individuos pertenece al grupo 1, dado los resultados mostrados sobre el ACM anterior, es de esperarse que las personas de este grupo sean las que no e encuentra bien representadas o caracterizadas por el ACM, es decir, aquellas que se encuentran cerca al origen en los planos factoriales.

Bajo el mismo argumento, es de esperarse que los individuos del grupo 4 estén bien representados y caracterizados por los ejes del ACM, siendo estos los individuos con mayor inercia.

### Valores Test

::: panel-tabset
#### Grupo 1

```{r}
#| label: valuest grupo1
#| message: false
#| echo: false
#| warning: false
#| output: true

kable(valores_test[["1"]]) %>% kable_styling("striped", full_width = T) %>% 
 scroll_box(height = "500px")
```

Mediante los valores test observamos varias características de este grupo. Inicialmente, los valores test $\infty$, nos dicen que hay una representación fuerte o casi perfecta entre dichas categorías y el grupo 1. Siendo así, las principales características de este grupo son las siguientes:

-   Este grupo posee características y proporciones muy próximas al promedio global en la mayoría de sus variables. Dentro de las variables características de este grupo, se encuentra que los individuos de este grupo tienden a tener mejores condiciones de vida intracarcelaria al compararlo con el promedio.

-   El grupo está compuesto un 98% por personas del sexo masculino, que representan al 85% de la población masculina encuestada.tambié, esta compuesto un 97% de personas heterosexuales que son alrededor del 60% de la población heterosexual.

-   Finalmente, el 29% de este grupo comparte celda con máximo 2 personas, que representa al 75% de esta categoria.

#### Grupo 2

```{r}
#| label: valuest grupo2
#| message: false
#| echo: false
#| warning: false
#| output: true


kable(valores_test[["2"]])%>%kable_styling("striped", full_width = T) %>% 
 scroll_box(height = "500px")
```

Mediante los valores test observamos varias características de este grupo. Inicialmente, los valores test $\infty$, nos dicen que hay una representación fuerte o casi perfecta entre dichas categorías y el grupo 2. Siendo así, las principales características de este grupo son las siguientes:

-   Las personas identificadas con el sexo Femenino están fuertemente representadas en este grupo, pues se tiene que el 74,5% de las personas de sexo femenino están dentro de el grupo 2. Además, alrededor del 98% de los miembros de este grupo son mujeres, lo cual es un porcentaje considerablemente alto al compararlo con el porcentaje de la población global, el cual es 19%.

-   De forma consecuente a lo anterior y a lo visto en el ACM, este grupo también representa fuertemente a las personas que se encuentran en un centro de reclusión femenino, donde alrededor del 58,8% de los individuos del grupos pertenecen a esta categoria.

-   Dada la relación vistas entre la orientación sexual y el sexo, se tiene que este grupo también está relacionado con las categorías "Bisexual" y "homosexual", donde alrededor del 53% y 59% de los individuos de estas categorias pertenecen a este grupo, que representan a un 15% y 7% de la población del grupo. Esto adquiere una mayor relevancia al comparar con la proporción de esta categoría en la población general, las cuales son 4.1% y 1.8%.

-   Alrededor del 19% de los individuos de este grupo, llevaban menos de 6 meses dentro del centro de reclusión al momento en el que fueron encuestadas. Esta población es el 40% de los individuos de esta categoría, esto es de importancia por su gran diferencia con la proporción de la población general, que es un 7%.

-   Finalmente, las condiciones de vida dentro de la celda y carcel son buenas, pues alrededor del 99% de las personas de este grupo tienden a poseer ducha, agua potable, sanitarios, drenaje y luz en su celda. Además de poseer espacios para lectura, servicio médico, hacer llamadas, recibir visitas y continuar sus estudios dentro del centro penitenciario.

#### Grupo 3

```{r}
#| label: valuest grupo3
#| message: false
#| echo: false
#| warning: false
#| output: true

kable(valores_test[["3"]]) %>%kable_styling("striped", full_width = T) %>% 
 scroll_box(height = "500px")
```

Mediante los valores test observamos varias características de este grupo. Inicialmente, los valores test $\infty$, nos dicen que hay una representación fuerte o casi perfecta entre dichas categorías y el grupo 3. Siendo así, las principales características de este grupo son las siguientes:

-   Existe una relación fuerte entre el grupo 3 y compartir celda con más de 10 personas. El 32,3% de las personas que comparten celda con más de 10 personas se encuentran en este grupo, y esta población resulta ser el 45% del grupo 3, es decir, casi la mitad de este grupo comparte celda con más de 10 personas; esto constrata con la población global, donde el 18.6% se encuentra en estas condiciones.

-   Además, este grupo también está relacionado con malas condiciones de vida dentro de la celda, pues poseen una proporción más alta respecto a la falta de servicio medico, ventanas en la celda,sensación de seguridad, espacios para lectura y espiritualidad respecto a la población global. Sin embargo, más del 90% del grupo tiene agua potable, ducha, sanitario y un sistema de drenaje en sus celdas.

-   Finalmente, pese a no tener una relación tan fuerte, este grupo está compuesto un 93% por personas del sexo masculino, que resultan ser el 15% de los hombres encuestados.

#### Grupo 4

```{r}
#| label: valuest grupo4
#| message: false
#| echo: false
#| warning: false
#| output: true

kable(valores_test[["4"]]) %>%kable_styling("striped", full_width = T) %>% 
 scroll_box(height = "500px")
```

Mediante los valores test observamos varias características de este grupo. Inicialmente, los valores test $\inf$, nos dicen que hay una representación fuerte o casi perfecta entre dichas categorías y el grupo 4. Siendo así, las principales características de este grupo son las siguientes:

-   Al igual que en el grupo 3, este grupo se encuentra fuertemente relacionado con la falta de condiciones saludables en la celda. Se destaca que más del 76% de la población de este grupo no cuenta con agua potable, ducha, sanitario o drenaje en la celda. Cabe a resaltar que este grupo contiene al 95% de los individuos que no contienen un drenaje o sanitario en su celda.

-   En contraste, este grupo tiende a poseer acceso a servicio médico y espacios de lectura, ejercicio, estudio y llamadas en el centro penitenciario.

-   Este grupo, al igual que el grupo 2, posee una fuerte relación con el sexo femenino, pues el 42.5% de este grupo está compuesto por mujeres, que representan el 13% de la población total de mujeres encuestadas. Así mismo, dada la relación del sexo con las carceles femeninas, el 31% de la población de este grupo pertenece a un centro penitenciario femenino.

-   El 39% de este grupo comparte celda con máximo 2 personas.
:::

Una vez determinamos algunas de las variables características de cada grupo. Podemos confirmarlo a partir de sus tablas de perfiles.

### Tablas de perfiles

::: panel-tabset
#### Sexo

```{r}
#| label: graficoperfilessexo
#| echo: false
tc<-table(DatosCualiIntra$GrupoFinal,DatosCualiIntra$SEXO)

    plotct(tc, "row", col=1+(1:ncol(tc)))

```

Esto concuerdo con lo visto anteriormente, pues alrededor del 99% del grupo 2 está compuesto por personas del sexo femenino. Tambié, el grupo 4 está compuesto 42% de las personas de este sexo, siendo los unicos grupos donde el sexo femenino tiene una presencia considerable dentro del grupo.

#### Agua potable

```{r}
#| label: graficoperfilesagua
#| echo: false
tc<-table(DatosCualiIntra$GrupoFinal,DatosCualiIntra$CELDA_AGUA_POTABLE)

    plotct(tc, "row", col=1+(1:ncol(tc)))

```

Como fue visto anteriormente, los grupos 3 y 4 se caracterizaron por la falta de condiciones en la celda, siendo el grupo 4 el más afectado por la falta de agua potable, drenaje, sanitario y duchas.

En cuenato el grupo 1 y 2, se vio caracterizado por las buenas condiciones de vida dentro de las celdas.

#### Personas celda

```{r}
#| label: graficoperfilescelda
#| echo: false
tc<-table(DatosCualiIntra$GrupoFinal,DatosCualiIntra$CAR_PERSONAS_CELDA)

    plotct(tc, "row", col=1+(1:ncol(tc)))

```

Como fue visto en la caracterización del grupo 3 y 4, el grupo 4 se caracterizó ya que alrededor del 40% de las personas no compartía celda con más de 2 personas. Y por el otro lado, el 45% de los individuos del grupo 3 comparten celda con más de 10 personas.

#### Lectura

```{r}
#| label: graficoperfilesEjercicio
#| echo: false
tc<-table(DatosCualiIntra$GrupoFinal,DatosCualiIntra$CARCEL_LECTURA)

    plotct(tc, "row", col=1+(1:ncol(tc)))

```

Como fue visto, el grupo 3 se caracteriza por la falta de servicios y condiciones saludables en la celda y en el centro penitenciario.

#### Ventanas

```{r}
#| label: graficoperfilesVentanas
#| echo: false
tc<-table(DatosCualiIntra$GrupoFinal,DatosCualiIntra$CELDA_VENTANAS)

    plotct(tc, "row", col=1+(1:ncol(tc)))

```

#### Tipo Carcel

```{r}
#| label: graficoperfilesTipoCarcel
#| echo: false
tc<-table(DatosCualiIntra$GrupoFinal,DatosCualiIntra$TIPO_CARCEL)

    plotct(tc, "row", col=1+(1:ncol(tc)))

```

Este gráfico está estrechamente relacionado con la variable SEXO, pues dado que el grupo 2 y 4 poseen la mayoría de mujeres, es de esperarse que estos contenga todas las personas de los centros penitenciarios femeninos. Y viceversa, dado que los grupos 1 y 3 están compuestos por hombres , es de esperarse que estos posean toda la población de los centros penitenciarios masculinos.

Llama la antención la justa proporción que hay entre el grupo 1,2 y la distribución marginal.

#### Tiempo Carcel

```{r}
#| label: graficoperfilesTiempoCarcel
#| echo: false
tc<-table(DatosCualiIntra$GrupoFinal,DatosCualiIntra$TIEMPO_CARCEL)

    plotct(tc, "row", col=1+(1:ncol(tc)))

```

Es de notar que el grupo 2, compuesto unicamente por mujeres, se caracterizan por haber llevado menos tiempo dentro de las carceles que las personas de los demás grupos.
:::

## Paso 8: Proyección de los grupos en los planos factoriales

Por último, veremos como se concentran y distribuye cada uno de estos grupos sobre los 3 ejes factoriales considerados.

::: panel-tabset
### Eje 1-2

```{r}
#| label: plano1-2
#| echo: false
#| output: true
fviz_mca_ind(acmIntra,label = "none",
             axes=c(1,2),
             habillage = Y$GrupoFinal,
             #col.ind= Y$GrupoFinal,
             palette = "jco",  addEllipses = TRUE,
             ellipse.type = "convex",
             repel = TRUE) 
```

### Eje 1-3

```{r}
#| label: plano1-3
#| echo: false
#| output: true
fviz_mca_ind(acmIntra,label = "none",
             axes=c(1,3),
             habillage = Y$GrupoFinal,
             #col.ind= Y$GrupoFinal,
             palette = "jco",  addEllipses = TRUE,
             ellipse.type = "convex",
             repel = TRUE) 
```

### Eje 2-3

```{r}
#| label: plano2-3
#| echo: false
#| output: true
fviz_mca_ind(acmIntra,label = "none",
             axes=c(2,3),
             habillage = Y$GrupoFinal,
             #col.ind= Y$GrupoFinal,
             palette = "jco",  addEllipses = TRUE,
             ellipse.type = "convex",
             repel = TRUE) 
```
:::

Tal como era de esperarse, el grupo 1, el cual contiene al 66.28% de la población, se concentra alrededor del origen, indicando que este grupo contiene a los individuos "independientes" o más semejantes al promedio en el ACM.

En cuanto a los grupos 2 y 3, estos están determinados principalmente por el segundo eje, al parecer de una forma opuesta. Por último, 4 está representado principalmente por el primer eje principal, sin embargo, posee una influencia fuerte del segundo eje, como puede observarse en el último plano factorial.
